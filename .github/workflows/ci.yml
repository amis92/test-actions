name: CI

on: [ push ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Read .NET Core SDK version
      id: globaljson
      shell: pwsh
      run: Write-Host "::set-output name=version::$((Get-Content global.json -Raw | ConvertFrom-Json).sdk.version)"

    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ steps.globaljson.outputs.version }}
      
    - run: dotnet --info
    - run: dotnet restore -v m
    - run: dotnet build --no-restore -c Release
    - run: dotnet pack -c Release
    - shell: pwsh
      run: |
        $ghp = "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json".ToLower()
        dotnet nuget add source $ghp -n github -u ${{ github.actor }} -p ${{ github.token }} --store-password-in-clear-text
        Get-ChildItem ~ -Recurse -File | ? Name -IMatch "^nuget\.config$" | select -ExpandProperty FullName
        # Get-Content ~/.local/share/nuget.config
        # dotnet nuget push src/bin/Release/*.nupkg -s github
